<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SEKIGACHA v0.9</title>
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue",
        "Segoe UI", system-ui, sans-serif;
      color-scheme: light;
      --bg: #ffffff;
      --text-main: #2b211c;
      --accent: #0d73c7;
      --seat-default: #b3b3b3;
      --seat-disabled: #e3e3e3;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: var(--bg);
    }

    .app {
      width: 100%;
      max-width: 360px;
      padding: 32px 24px 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
    }

    /* タイトル */
    .title {
      text-align: center;
    }
    .title-main {
      font-size: 28px;
      letter-spacing: 0.18em;
      font-weight: 700;
      color: var(--text-main);
    }
    .title-sub {
      margin-top: 4px;
      font-size: 11px;
      letter-spacing: 0.12em;
      color: #8c6e57;
    }

    /* 座席レイアウト全体 */
    .seating {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 28px;
      align-items: center;
    }

    .row {
      display: flex;
      gap: 28px;
    }

    .island {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .seat-row {
      display: flex;
      align-items: center;
      gap: 4px;
      justify-content: center;
    }

    .seat-desk {
      --seat-color: var(--seat-default);
      width: 14px;
      height: 32px;
      border-radius: 2px;
      background: var(--seat-color);
      position: relative;
      transition: background 0.15s ease-out, opacity 0.15s ease-out,
        transform 0.15s ease-out;
    }

    .seat-desk.chair-right::after,
    .seat-desk.chair-left::before {
      content: "";
      position: absolute;
      top: 3px;
      width: 8px;
      height: 26px;
      border-radius: 16px;
      border: 3px solid var(--seat-color);
    }

    .seat-desk.chair-right::after {
      right: -7px;
      border-left: none;
    }
    .seat-desk.chair-left::before {
      left: -7px;
      border-right: none;
    }

    /* 状態 */
    .seat-desk.is-current {
      --seat-color: var(--accent);
      transform: translateX(0);
    }

    .seat-desk.is-disabled {
      --seat-color: var(--seat-disabled);
      opacity: 0.35;
    }

    /* ボタン */
    .actions {
      margin-top: 8px;
      width: 100%;
      display: flex;
      justify-content: center;
    }

    .btn-main {
      width: 70%;
      max-width: 260px;
      border: none;
      border-radius: 999px;
      padding: 12px 16px;
      background: #1fa4ea;
      color: #ffffff;
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 0.12em;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 10px 18px rgba(0, 0, 0, 0.18);
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.08s ease-out, box-shadow 0.1s ease-out,
        opacity 0.15s ease-out, background 0.15s ease-out;
    }

    .btn-main:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.18);
    }

    .btn-main:disabled {
      opacity: 0.5;
      box-shadow: none;
      cursor: default;
      background: #9ca3af;
    }

    .message {
      margin-top: 6px;
      font-size: 11px;
      color: #777;
      text-align: center;
      min-height: 1.4em;
    }

    /* ローディングオーバーレイ */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.75);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      backdrop-filter: blur(4px);
      transition: opacity 0.2s ease-out, visibility 0.2s ease-out;
    }

    .overlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 4px solid #d4d4d4;
      border-top-color: #1fa4ea;
      animation: spin 0.8s linear infinite;
      margin-bottom: 8px;
    }

    .overlay-text {
      font-size: 12px;
      color: #555;
      letter-spacing: 0.08em;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <!-- ローディングオーバーレイ -->
  <div id="loadingOverlay" class="overlay">
    <div class="spinner"></div>
    <div class="overlay-text">席をシャッフル中…</div>
  </div>

  <main class="app">
    <header class="title">
      <div class="title-main">SEKIGACHA</div>
      <div class="title-sub">v0.9</div>
    </header>

    <section class="seating" id="seating">
      <!-- JSで座席ブロックを生成 -->
    </section>

    <section class="actions">
      <button id="btnKoreJanai" class="btn-main">
        コレジャナイ
      </button>
    </section>
    <div class="message" id="message"></div>
  </main>

  <script>
    // ===== 設定値 =====
    const LOADING_DELAY_MS = 900; // ローディング演出のディレイ

    // レイアウト定義（添付UIに近い 4×2 の島構成）
    // type: "single" → 片側だけ椅子, "double" → 両側に椅子
    const layoutDefinition = [
      [
        { type: "single", rows: 3 },
        { type: "double", rows: 3 },
        { type: "double", rows: 3 },
        { type: "double", rows: 3 },
      ],
      [
        { type: "single", rows: 3 },
        { type: "double", rows: 3 },
        { type: "double", rows: 3 },
        { type: "double", rows: 3 },
      ],
    ];

    const seatingEl = document.getElementById("seating");
    const btnKoreJanai = document.getElementById("btnKoreJanai");
    const messageEl = document.getElementById("message");
    const overlayEl = document.getElementById("loadingOverlay");

    let seatEls = {}; // seatId -> element
    let seatState = {}; // seatId -> "available" | "rejected"
    let currentSeatId = null;

    // ===== 座席DOM生成 =====
    function buildLayout() {
      let seatCounter = 1;
      seatingEl.innerHTML = "";

      layoutDefinition.forEach((rowDef) => {
        const rowEl = document.createElement("div");
        rowEl.className = "row";

        rowDef.forEach((islandDef) => {
          const islandEl = document.createElement("div");
          islandEl.className = "island island-" + islandDef.type;

          for (let r = 0; r < islandDef.rows; r++) {
            const rowSeatEl = document.createElement("div");
            rowSeatEl.className = "seat-row";

            if (islandDef.type === "single") {
              const desk = createSeatDesk(`S${seatCounter++}`, {
                chairRight: true,
              });
              rowSeatEl.appendChild(desk);
            } else if (islandDef.type === "double") {
              const deskLeft = createSeatDesk(`S${seatCounter++}`, {
                chairLeft: true,
              });
              const deskRight = createSeatDesk(`S${seatCounter++}`, {
                chairRight: true,
              });
              rowSeatEl.appendChild(deskLeft);
              rowSeatEl.appendChild(deskRight);
            }

            islandEl.appendChild(rowSeatEl);
          }

          rowEl.appendChild(islandEl);
        });

        seatingEl.appendChild(rowEl);
      });
    }

    function createSeatDesk(id, opts) {
      const el = document.createElement("div");
      el.className = "seat-desk";
      el.dataset.seatId = id;

      if (opts?.chairRight) el.classList.add("chair-right");
      if (opts?.chairLeft) el.classList.add("chair-left");

      seatEls[id] = el;
      seatState[id] = "available";

      return el;
    }

    // ===== ローディング制御 =====
    function showOverlay() {
      overlayEl.classList.remove("hidden");
    }

    function hideOverlay() {
      overlayEl.classList.add("hidden");
    }

    // ===== 座席ロジック =====
    function pickRandomAvailableSeat() {
      const candidates = Object.keys(seatState).filter(
        (id) => seatState[id] === "available" && id !== currentSeatId
      );
      if (candidates.length === 0) return null;
      const index = Math.floor(Math.random() * candidates.length);
      return candidates[index];
    }

    function setCurrentSeat(seatId) {
      if (currentSeatId && seatEls[currentSeatId]) {
        seatEls[currentSeatId].classList.remove("is-current");
      }
      currentSeatId = seatId;
      if (seatId && seatEls[seatId]) {
        seatEls[seatId].classList.add("is-current");
      }
    }

    function rejectCurrentSeat() {
      if (!currentSeatId) return;
      seatState[currentSeatId] = "rejected";
      const el = seatEls[currentSeatId];
      if (el) {
        el.classList.remove("is-current");
        el.classList.add("is-disabled");
      }
      currentSeatId = null;
    }

    function updateMessage(text) {
      messageEl.textContent = text || "";
    }

    // 「次の席を選ぶ」＋ローディング演出
    function rollNextSeat({ rejectCurrent = false } = {}) {
      btnKoreJanai.disabled = true;
      showOverlay();

      setTimeout(() => {
        if (rejectCurrent) {
          rejectCurrentSeat();
        }

        const nextId = pickRandomAvailableSeat();
        if (!nextId) {
          setCurrentSeat(null);
          hideOverlay();
          updateMessage("もう空いている席はありません。");
          btnKoreJanai.disabled = true;
          return;
        }

        setCurrentSeat(nextId);
        hideOverlay();
        updateMessage("この席でよければそのまま、違えば「コレジャナイ」。");
        btnKoreJanai.disabled = false;
        navigator.vibrate?.(40);
      }, LOADING_DELAY_MS);
    }

    // ===== イベント =====
    btnKoreJanai.addEventListener("click", () => {
      // 現在の席を候補から外して次を引く
      rollNextSeat({ rejectCurrent: true });
    });

    // ===== 初期化 =====
    buildLayout();
    // 初回の自動ガチャ
    window.addEventListener("load", () => {
      rollNextSeat({ rejectCurrent: false });
    });
  </script>
</body>
</html>
